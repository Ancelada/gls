<!DOCTYPE HTML>

<html lang="en">
	<head>
		<meta charset="UTF-8">
        <meta content="user-scalable=no" name="viewport">
		<title>Our WebGl</title>
		{% load staticfiles %}
        {% load poll_extras %}
        {% load jsonify %}
		<script type="text/javascript" src="{% static 'js/vendor/jquery-2.2.0.js' %}"></script>
        <script type="text/javascript" src="{% static 'js/vendor/foundation.core.js' %}"></script>
        <script type="text/javascript" src="{% static 'js/attrchange.js' %}"></script>
		<script type="text/javascript" src="{% static 'js/three.min.js' %}"></script>
		<script type="text/javascript" src="{% static 'js/dat.gui.min.js' %}"></script>
		<script type="text/javascript" src="{% static 'js/OrbitControls.js' %}"></script>
		<script type="text/javascript" src="{% static 'js/stats.min.js' %}"></script>
		<script type="text/javascript" src="{% static 'js/helvetiker_regular.typeface.js' %}"></script>
		<script type="text/javascript" src="{% static 'js/ColladaLoader.js' %}"></script>
        <script type="text/javascript" src="{% static 'js/sockjs.min.js' %}"></script>

  		<link rel="stylesheet" href="{% static 'css/foundation.css' %}">
    	<link rel="stylesheet" href="{% static 'css/app.css' %}">


		<style>
			body{
				margin:0;
				overflow:hidden;
			}
		</style>
	</head>
	<body>
		{% csrf_token %}
        {% if username %}
        <div id="objectwindow"></div>
		<!-- ***блок 3д изображения*** -->
		<!--************************-->
		<div id ="webGL-container"></div>
        <!-- ***блок панель управления*** -->
        <!--************************-->
        <div class="small-4 columns" id="mobile-control-panel">
            <div class="small-12 columns" style="padding:0">
                <div class="small-12 columns" style="padding:0">
                    <button id="up" class="button large float-center">Вверх</button>
                </div>
                <div class="small-12 columns" style="padding:0">
                    <button id="left" class="button large float-left small-5 columns">Влево</button>
                    <button id="right" class="button large float-right small-5 columns">Вправо</button>
                </div>
                <div class="small-12 columns" style="padding:0">
                    <button id="down" class="button large float-center">Вниз</button>
                </div>
            </div>
        </div>
        <button class="button large show_hide_button">Строения</button>
        <button class="button alert large income_zone_button">Зоны входа</button>
        <button class="button success large exclude_zone_button">Зоны исключения</button>
        <button class="button large user_zone_button">Зоны пользователя</button>
        <button class="button large warning add_object_button">Добавить объект</button>
        <div class="large-3 small-3 columns popup" style="padding-left:0px;padding-right:0px;">
            <ul class="tabs vertical" id="example-vert-tabs" data-tabs>


            </ul>
        </div>
        <!-- Блок объектов -->
        <div class="add_object_block large-3 small-4 columns" style="right:-100%;">
            <fieldset class="large-12 small-12 columns" style="float:none;">
                <h3 class="subheader">Список объектов</h3>
                <div class="large-12 small-12 columns" id="objecttable">
                    {{objecttable}}
                </div>
                <button class="button" id="newobject">Новый</button>
            </fieldset>
            <fieldset class="large-12 small-12 columns">
                <button class="close-button add_object_close" aria-label="Close menu" type="button">
                     <span aria-hidden="true">x</span>
                </button>
                <input type="checkbox" id="showobjects"><label for="showobjects">Показывать объекты</label>
                <h3 class="subheader">Тип объекта</h3>
                <select name="" id="objecttype">
                    {% for type in objecttype %}
                        <option value="{{type.id}}">{{type.Name}}</option>
                    {% endfor %}
                </select>
                <button class="button success" data-landscape="{{landscape_id}}" data-type="" id="sendserver">Отправить все объекты указанного типа на сервер</button>
                <label for="objectsize">Размер экземпляров объектов
                    <input id="objectsize" type="number" value="1" step="0.01">    
                </label>
                <label for="objectcolor">Цвет экземпляров объектов
                    <input class="jscolor" value="" id="objectcolor">
                </label>
                <button class="button" id="showallobjects">Отобразить на сцене все объекты указанного типа</button>
                <button class="button alert" id="hideallobjects">Скрыть со сцены все объекты указанного типа</button>
            </fieldset>
        </div>
        <!-- Блок интрументов -->
        <div class="instrument_block large-3 small-4 columns" style="right:-100%;">
            <fieldset class="large-12 small-12 columns">
                <button class="close-button close_panel" aria-label="Close menu" type="button">
                    <span aria-hidden="true">x</span>
                </button>
                <br>
                <h3 class="subheader">Качество графики</h3>
                <ul class="tabs" data-tabs id="example-tabs">
                    <li class="tabs-title is-active" id="high"><a>Высокое</a></li>
                    <li class="tabs-title" id="low"><a>Низкое</a></li>
                </ul>
                <h3 class="subheader">Объекты</h3>
                <ul class="vertical menu objects_tree" data-drilldown data-options="backButton:<li class='js-drilldown-back'><a>Назад</a></li>;">
                    {% for building in buildings %}
                    <li onclick="$('.cursor_box span').text(jQuery('a', this).first().attr('data-dae'));">
                        <a href="#" data-dae="{{building.dae_BuildingName}}">{% if building.BuildingName != None%}{{building.BuildingName}}{% else %}{{building.dae_BuildingName}}{%endif%}</a>
                        <ul class="vertical menu">
                        {% for floor in floors %}
                            {% if building.id == floor.Building_id %}
                                <li onclick="$('.cursor_box span').text(jQuery('a', this).first().attr('data-dae'));">
                                    <a href="#" data-dae="{{floor.dae_FloorName}}">{% if floor.FloorName != None %}{{floor.FloorName}}{% else %}{{floor.dae_FloorName}}{% endif%}</a>
                                    <ul class="vertical menu">
                                    {% for k in kabinet_n_outer %}
                                        {% if k.Floor_id == floor.id %}
                                        <li onclick="$('.cursor_box span').text(jQuery('a', this).first().attr('data-dae'));">
                                            <a href="#" data-dae="{{k.dae_Kabinet_n_OuterName}}">{% if k.Kabinet_n_OuterName != None %}{{k.Kabinet_n_OuterName}}{% else %}{{k.dae_Kabinet_n_OuterName}}{% endif %}</a>
                                            <ul class="vertical menu">
                                                <!-- {% for wall in walls %}
                                                    {% if wall.Kabinet_n_Outer_id == k.id %}
                                                    <li onclick="$('.cursor_box span').text(jQuery('a', this).first().attr('data-dae'));">
                                                        <a href="#" data-dae="{{wall.dae_WallName}}">{{wall.dae_WallName}}</a>
                                                        <ul class="vertical menu"></ul>
                                                    </li>
                                                    {% endif %}
                                                {% endfor %} -->
                                            </ul>
                                        </li>
                                        {% endif %}
                                    {% endfor %}
                                    </ul>
                                </li>
                            {% endif %}
                        {% endfor %}
                        </ul>        
                    </li>
                    {% endfor %}                    
                </ul>
            </fieldset>
            <fieldset class="large-12 small-12 columns cursor_box">
                <span class="label large-12 small-12 columns" style="margin-top:15px;"></span>
                <br>
            </fieldset>
            <fieldset class="large-12 small-12 columns">
                <a href="#" class="secondary hollow button large button_style select_object" style="font-size:100%;">Выбрать</a>
                <a href="#" class="secondary hollow button large button_style camera" style="font-size:100%;">Навести камеру</a>    
            </fieldset>
            <fieldset class="large-12 small-12 columns">
                <!-- <h3 class="subheader">Видимость</h3> -->
                <ul class="tabs" data-tabs id="example-tabs">
                    <li class="tabs-title is-active" id="turn_on"><a href="#panel1">Показать</a></li>
                    <li class="tabs-title" id="turn_off"><a href="#panel2">Скрыть</a></li>
                </ul>
            </fieldset>
            <fieldset class="large-12 small-12 columns">
                <h3 class="subheader">Видимость</h3>
                <div class="slider" data-slider data-initial-start="1" data-start="0" data-end="1">
                    <span class="slider-handle" data-slider-handle role="slider" tabindex="1"></span>
                    <span class="slider-fill" data-slider-fill></span>
                    <input type="hidden" id="building_opacity">
                </div>
            </fieldset>
        </div>
        <!-- Блок настройки зон входа -->
        <div class="incomezone_panel large-3 small-4 columns" style="right:-100%;overflow:visible;">
            <button class="close-button close_incomezone_panel" aria-label="Close menu" type="button">
                <span aria-hidden="true">x</span>
            </button>
            <br>
            <br>
            <fieldset class="large-12 small-12 columns">
                <h3 class="subheader">Список зон входа</h3>
                <div class="large-12 small-12 columns" id="zonetable">
                    <table>
                        <thead>
                            <tr>
                                <th>Статус</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for z in zones %}
                                <tr>
                                    <td class="subheader">

                                        {% for izuz in izoneuzone %}
                                          {% if izuz.IncomeZone_id == z.id %}
                                            <span data-tooltip aria-haspopup="true" class="has-tip" data-disable-hover="false" tabindex="1" title="{% for uz in uzones %}{% if uz.id == izuz.UserZone_id%}{% if not uz.UserZoneName %}{{uz.id}}{% else %}{{uz.UserZoneName}}{% endif %}{% endif %}{% endfor %}">Привязана к ЗП
                                            </span><a href="#" id="unlinkIncomeZoneToUserZone" data-izuz="{{izuz.id}}">Отвязать</a>
                                          {% endif %}
                                        {% endfor %}

                                        {% for bz in bIncomeZone %}
                                            {% if bz.IncomeZone_id == z.id %}
                                                <span data-tooltip aria-haspopup="true" class="has-tip" data-disable-hover="false" tabindex="1" title="{% for b in buildings %}{% if b.id == bz.Building_id%}{% if not b.BuildingName or b.BuildingName = '' %}{{b.dae_BuildingName}} id:{{z.id}}{% else %}{{b.BuildingName}} id:{{z.id}}{% endif %}{% endif %}{% endfor %}">Привязана</span> <a href="#" id="unlink" data-id="{{z.id}}">Отвязать</a>
                                            {% endif %}
                                        {% endfor %}

                                        {% for fz in fIncomeZone %}
                                            {% if fz.IncomeZone_id == z.id %}
                                                <span data-tooltip aria-haspopup="true" class="has-tip" data-disable-hover="false" tabindex="1" title="{% for f in floors %}{% if f.id == fz.Floor_id%}{% if not f.FloorName or f.FloorName == '' %}{{f.dae_FloorName}} {{z.id}}{% else %}{{f.FloorName}} {{z.id}}{% endif %}{% endif %}{% endfor %}">Привязана</span> <a href="#" id="unlink" data-id="{{z.id}}">Отвязать</a>
                                            {% endif %}
                                        {% endfor %}

                                        {% for kz in kIncomeZone %}
                                            {% if kz.IncomeZone_id == z.id %}
                                                <span data-tooltip aria-haspopup="true" class="has-tip" data-disable-hover="false" tabindex="1" title="{% for k in kabinet_n_outer %}{% if k.id == kz.Kabinet_id %}{% if not k.Kabinet_n_OuterName or k.Kabinet_n_OuterName == '' %}{{k.dae_Kabinet_n_OuterName}} {{z.id}}{% else %}{{k.Kabinet_n_OuterName}} {{z.id}}{% endif %}{% endif %}{% endfor %}">Привязана</span> <a href="#" id="unlink" data-id="{{z.id}}">Отвязать</a>
                                            {% endif %}
                                        {% endfor %}
                                    </td>
                                    <td>
                                        <button class="button" data-toggle="dropdown{{z.id}}">Действие</button>
                                        <div class="dropdown-pane left" id="dropdown{{z.id}}" data-dropdown style="width:200px;">
                                            <ul class="vertical dropdown menu" data-dropdown-menu>
                                                <li><a href="#" id="show" data-id="{{z.id}}">Показать</a></li>
                                                <li>
                                                    <a href="#" id="delete" data-id="{{z.id}}">Удалить</a>
                                                </li>
                                                <li>
                                                    <a href="#">Привязать</a>
                                                    <ul class="menu">
                                                    {% for b in buildings %}
                                                        <li><a href="#" data-type="building" data-id="{{b.id}}" id="link" data-zoneid="{{z.id}}">{% if not b.BuildingName or b.BuildingName == '' %}{{b.dae_BuildingName}}{% else %}{{b.BuildingName}}{%endif%}</a>
                                                            <ul class="menu">
                                                                {% for f in floors %}
                                                                {% if f.Building_id == b.id %}
                                                                <li><a href="#" data-type="floor" data-id="{{f.id}}" id="link" data-zoneid="{{z.id}}">{% if not f.FloorName or f.FloorName == '' %}{{f.dae_FloorName}}{% else %}{{f.FloorName}}{% endif %}</a>
                                                                    <ul class="menu" style="max-height:200px;overflow-y:scroll;">
                                                                    {% for k in kabinet_n_outer %}
                                                                    {% if k.Floor_id = f.id %}
                                                                    <li><a href="#" data-type="kabinet" data-id="{{k.id}}" id="link" data-zoneid="{{z.id}}">{% if not k.Kabinet_n_OuterName or k.Kabinet_n_OuterName == '' %}{{k.dae_Kabinet_n_OuterName}}{% else %}{{k.Kabinet_n_OuterName}}{% endif%}</a></li>
                                                                    {% endif %}
                                                                    {% endfor %}
                                                                    </ul>
                                                                </li>
                                                                {% endif %}
                                                                {% endfor %}
                                                            </ul>
                                                        </li>
                                                    {% endfor %}        
                                                    </ul>
                                                </li>
                                                <li>
                                                    <a href="#">Привязать к зоне пользователя</a>
                                                    <ul class="menu" style="max-height:200px;overflow-y:scroll;">
{% for uz in uzones %}
        <li><a href="#" data-uzone="{{uz.id}}" data-izone="{{z.id}}" id="linkIncomeZoneToUserZone">{% if not uz.UserZoneName%}{{uz.id}}{% else %}{{uz.UserZoneName}}{% endif%}</a></li>
{% endfor %}
                                                    </ul>
                                                </li>
                                                <li>
                                                    <a href="#">Откорректировать высоту</a>
                                                    <ul class="menu">
                                                        <li><a href="#">Минимум</a>
                                                            <ul class="menu">
                                                                <li>
<label for="">Значение
    <input type="number" step="0.01" data-type="min" data-id="{{z.id}}" placeholder="{% for bz in bIncomeZone %}{% if bz.IncomeZone_id == z.id %}{% for b in buildings%}{% if b.id == bz.Building_id%}{{b.minz}}{% endif %}{%endfor%}{% endif %}{%endfor%}{% for fz in fIncomeZone %}{% if fz.IncomeZone_id == z.id%}{% for f in floors%}{% if f.id == fz.Floor_id%}{{f.minz}}{%endif%} {%endfor%}{% endif %}{%endfor%}{% for kz in kIncomeZone %}{% if kz.IncomeZone_id == z.id%}{% for k in kabinet_n_outer%}{% if k.id == kz.Kabinet_id%}{{k.minz}}{%endif%}{%endfor%}{%endif%}{% endfor %}"></li>    
</label>
<button class="button" id="savemin" data-id="{{z.id}}">Сохранить</button>
                                                            </ul>
                                                        </li>
                                                        <li><a href="#" >Максимум</a>
                                                            <ul class="menu">
                                                                <li>
<label for="">Значение
    <input type="number" step="0.01" data-type="max" data-id="{{z.id}}" placeholder="{% for bz in bIncomeZone %}{% if bz.IncomeZone_id == z.id %}{% for b in buildings%}{% if b.id == bz.Building_id%}{{b.maxz}}{% endif %}{%endfor%}{% endif %}{%endfor%}{% for fz in fIncomeZone %}{% if fz.IncomeZone_id == z.id%}{% for f in floors%}{% if f.id == fz.Floor_id%}{{f.maxz}}{%endif%} {%endfor%}{% endif %}{%endfor%}{% for kz in kIncomeZone %}{% if kz.IncomeZone_id == z.id%}{% for k in kabinet_n_outer%}{% if k.id == kz.Kabinet_id%}{{k.maxz}}{%endif%}{%endfor%}{%endif%}{% endfor %}">
</label>
<button class="button" id="savemax" data-id="{{z.id}}">Сохранить</button>
                                                                </li>
                                                            </ul>
                                                        </li>
                                                    </ul>
                                                </li>
                                            </ul>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <button class="button" id="new">Новая</button>
            </fieldset>
            <label class="lessvert label alert" style="display:none;">Мало вершин</label>
        </div>
        <!-- блок зоны исключения -->
        <div class="excludezone_panel large-3 small-4 columns" style="right:-100%;overflow:visible;">
            <button class="close-button close_excludezone_panel" aria-label="Close menu" type="button">
                <span aria-hidden="true">x</span>
            </button>
            <br>
            <br>
            <fieldset class="large-12 small-12 columns">
                <h3 class="subheader">Список зон исключения</h3>
                <div class="large-12 small-12 columns" id="excludezonetable">
                    <table>
                        <thead>
                            <tr>
                                <th>Статус</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for z in ezones %}
                                <tr>
                                    <td class="subheader">
                                        {% for ezuz in ezoneuzone %}
                                          {% if ezuz.ExcludeZone_id == z.id %}
                                            <span data-tooltip aria-haspopup="true" class="has-tip" data-disable-hover="false" tabindex="1" title="{% for uz in uzones %}{% if uz.id == ezuz.UserZone_id%}{% if not uz.UserZoneName %}{{uz.id}}{% else %}{{uz.UserZoneName}}{% endif %}{% endif %}{% endfor %}">Привязана к ЗП
                                            </span><a href="#" id="unlinkExcludeZoneToUserZone" data-ezuz="{{ezuz.id}}">Отвязать</a>
                                          {% endif %}
                                        {% endfor %}                          

                                        {% for bz in bExcludeZone %}
                                            {% if bz.ExcludeZone_id == z.id %}
                                                <span data-tooltip aria-haspopup="true" class="has-tip" data-disable-hover="false" tabindex="1" title="{% for b in buildings %}{% if b.id == bz.Building_id%}{% if not b.BuildingName or b.BuildingName = '' %}{{b.dae_BuildingName}} id:{{z.id}}{% else %}{{b.BuildingName}} id:{{z.id}}{% endif %}{% endif %}{% endfor %}">Привязана</span> <a href="#" id="unlink_exclude" data-id="{{z.id}}">Отвязать</a>
                                            {% endif %}
                                        {% endfor %}

                                        {% for fz in fExcludeZone %}
                                            {% if fz.ExcludeZone_id == z.id %}
                                                <span data-tooltip aria-haspopup="true" class="has-tip" data-disable-hover="false" tabindex="1" title="{% for f in floors %}{% if f.id == fz.Floor_id%}{% if not f.FloorName or f.FloorName == '' %}{{f.dae_FloorName}} id:{{z.id}}{% else %}{{f.FloorName}} id:{{z.id}}{% endif %}{% endif %}{% endfor %}">Привязана</span> <a href="#" id="unlink_exclude" data-id="{{z.id}}">Отвязать</a>
                                            {% endif %}
                                        {% endfor %}

                                        {% for kz in kExcludeZone %}
                                            {% if kz.ExcludeZone_id == z.id %}
                                                <span data-tooltip aria-haspopup="true" class="has-tip" data-disable-hover="false" tabindex="1" title="{% for k in kabinet_n_outer %}{% if k.id == kz.Kabinet_id %}{% if not k.Kabinet_n_OuterName or k.Kabinet_n_OuterName == '' %}{{k.dae_Kabinet_n_OuterName}} id:{{z.id}}{% else %}{{k.Kabinet_n_OuterName}} id:{{z.id}}{% endif %}{% endif %}{% endfor %}">Привязана</span> <a href="#" id="unlink_exclude" data-id="{{z.id}}">Отвязать</a>
                                            {% endif %}
                                        {% endfor %}
                                    </td>
                                    <td>
                                        <button class="button" data-toggle="dropdownexclude{{z.id}}">Действие</button>
                                        <div class="dropdown-pane left" id="dropdownexclude{{z.id}}" data-dropdown style="width:200px;">
                                            <ul class="vertical dropdown menu" data-dropdown-menu>
                                                <li><a href="#" id="show_exclude" data-id="{{z.id}}">Показать</a></li>
                                                <li>
                                                    <a href="#" id="delete_exclude" data-id="{{z.id}}">Удалить</a>
                                                </li>
                                                <li>
                                                    <a href="#">Привязать</a>
                                                    <ul class="menu">
                                                    {% for b in buildings %}
                                                        <li><a href="#" data-type="building" data-id="{{b.id}}" id="link_exclude" data-zoneid="{{z.id}}">{% if not b.BuildingName or b.BuildingName == '' %}{{b.dae_BuildingName}}{% else %}{{b.BuildingName}}{%endif%}</a>
                                                            <ul class="menu">
                                                                {% for f in floors %}
                                                                {% if f.Building_id == b.id %}
                                                                <li><a href="#" data-type="floor" data-id="{{f.id}}" id="link_exclude" data-zoneid="{{z.id}}">{% if not f.FloorName or f.FloorName == '' %}{{f.dae_FloorName}}{% else %}{{f.FloorName}}{% endif %}</a>
                                                                    <ul class="menu" style="max-height:200px;overflow-y:scroll;">
                                                                    {% for k in kabinet_n_outer %}
                                                                    {% if k.Floor_id = f.id %}
                                                                    <li><a href="#" data-type="kabinet" data-id="{{k.id}}" id="link_exclude" data-zoneid="{{z.id}}">{% if not k.Kabinet_n_OuterName or k.Kabinet_n_OuterName == '' %}{{k.dae_Kabinet_n_OuterName}}{% else %}{{k.Kabinet_n_OuterName}}{% endif%}</a></li>
                                                                    {% endif %}
                                                                    {% endfor %}
                                                                    </ul>
                                                                </li>
                                                                {% endif %}
                                                                {% endfor %}
                                                            </ul>
                                                        </li>
                                                    {% endfor %}        
                                                    </ul>
                                                </li>
                                                <li>
                                                    <a href="#">Привязать к зоне пользователя</a>
                                                    <ul class="menu" style="max-height:200px;overflow-y:scroll;">
    {% for uz in uzones %}
            <li><a href="#" data-uzone="{{uz.id}}" data-ezone="{{z.id}}" id="linkExcludeZoneToUserZone">{% if not uz.UserZoneName%}{{uz.id}}{% else %}{{uz.UserZoneName}}{% endif%}</a></li>
    {% endfor %}
                                                    </ul>
                                                </li>
                                                <li>
                                                    <a href="#">Откорректировать высоту</a>
                                                    <ul class="menu">
                                                        <li><a href="#">Минимум</a>
                                                            <ul class="menu">
                                                                <li>
<label for="">Значение
    <input type="number" step="0.01" data-type="min" data-id="{{z.id}}" placeholder="{% for bz in bExcludeZone %}{% if bz.ExcludeZone_id == z.id %}{% for b in buildings%}{% if b.id == bz.Building_id%}{{b.minz}}{% endif %}{%endfor%}{% endif %}{%endfor%}{% for fz in fExcludeZone %}{% if fz.ExcludeZone_id == z.id%}{% for f in floors%}{% if f.id == fz.Floor_id%}{{f.minz}}{%endif%} {%endfor%}{% endif %}{%endfor%}{% for kz in kExcludeZone %}{% if kz.ExcludeZone_id == z.id%}{% for k in kabinet_n_outer%}{% if k.id == kz.Kabinet_id%}{{k.minz}}{%endif%}{%endfor%}{%endif%}{% endfor %}"></li>    
</label>
<button class="button" id="savemin_exclude" data-id="{{z.id}}">Сохранить</button>
                                                            </ul>
                                                        </li>
                                                        <li><a href="#" >Максимум</a>
                                                            <ul class="menu">
                                                                <li>
<label for="">Значение
    <input type="number" step="0.01" data-type="max" data-id="{{z.id}}" placeholder="{% for bz in bExcludeZone %}{% if bz.ExcludeZone_id == z.id %}{% for b in buildings%}{% if b.id == bz.Building_id%}{{b.maxz}}{% endif %}{%endfor%}{% endif %}{%endfor%}{% for fz in fExcludeZone %}{% if fz.ExcludeZone_id == z.id%}{% for f in floors%}{% if f.id == fz.Floor_id%}{{f.maxz}}{%endif%} {%endfor%}{% endif %}{%endfor%}{% for kz in kExcludeZone %}{% if kz.ExcludeZone_id == z.id%}{% for k in kabinet_n_outer%}{% if k.id == kz.Kabinet_id%}{{k.maxz}}{%endif%}{%endfor%}{%endif%}{% endfor %}">
</label>
<button class="button" id="savemax_exclude" data-id="{{z.id}}">Сохранить</button>
                                                                </li>
                                                            </ul>
                                                        </li>
                                                    </ul>
                                                </li>
                                            </ul>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <button class="button" id="new_exclude">Новая</button>
            </fieldset>
            <label class="exclude_lessvert label alert" style="display:none;">Мало вершин</label>
        </div>
        <!-- блок зоны пользователя-->
        <div class="userzone_panel large-3 small-4 columns" style="right:-100%;overflow:visible;">
            <button class="close-button close_userzone_panel" aria-label="Close menu" type="button">
                <span aria-hidden="true">x</span>
            </button>
            <fieldset class="large-12 small-12 columns">
                <h3 class="subheader">Список зон пользователя</h3>
                <div class="large-12 small-12 columns" id="userzonetable">
                    <table>
                        <thead>
                        <tr>
                            <th>Наименование</th>
                            <th>Действие</th>
                        </tr>
                        </thead>
                        <tbody>
                            {% for u in uzones %}
                                <tr>
                                    <td>
                                        {{u.UserZoneName}}
                                        {% for lz in lUserZone %}
                                            {% if lz.UserZone_id == u.id %}
                                                <span data-tooltip aria-haspopup="true" class="has-tip" data-disable-hover="false" tabindex="1" title="{{sceneop.landscape_name}} id:{{u.id}}">Привязана</span> <a href="#" id="unlink_uzone" data-id="{{u.id}}">Отвязать</a>
                                            {% endif %}
                                        {% endfor %}

                                        {% for bz in bUserZone %}
                                            {% if bz.UserZone_id == u.id %}
                                                <span data-tooltip aria-haspopup="true" class="has-tip" data-disable-hover="false" tabindex="1" title="{% for b in buildings %}{% if b.id == bz.Building_id%}{% if not b.BuildingName or b.BuildingName = '' %}{{b.dae_BuildingName}} id:{{u.id}}{% else %}{{b.BuildingName}} id:{{u.id}}{% endif %}{% endif %}{% endfor %}">Привязана</span> <a href="#" id="unlink_uzone" data-id="{{u.id}}">Отвязать</a>
                                            {% endif %}
                                        {% endfor %}

                                        {% for fz in fUserZone %}
                                            {% if fz.UserZone_id == u.id %}
                                                <span data-tooltip aria-haspopup="true" class="has-tip" data-disable-hover="false" tabindex="1" title="{% for f in floors %}{% if f.id == fz.Floor_id%}{% if not f.FloorName or f.FloorName == '' %}{{f.dae_FloorName}} id:{{u.id}}{% else %}{{f.FloorName}} id:{{u.id}}{% endif %}{% endif %}{% endfor %}">Привязана</span> <a href="#" id="unlink_uzone" data-id="{{u.id}}">Отвязать</a>
                                            {% endif %}
                                        {% endfor %}

                                        {% for kz in kUserZone %}
                                            {% if kz.UserZone_id == u.id %}
                                                <span data-tooltip aria-haspopup="true" class="has-tip" data-disable-hover="false" tabindex="1" title="{% for k in kabinet_n_outer %}{% if k.id == kz.Kabinet_id %}{% if not k.Kabinet_n_OuterName or k.Kabinet_n_OuterName == '' %}{{k.dae_Kabinet_n_OuterName}} id:{{u.id}}{% else %}{{k.Kabinet_n_OuterName}} id:{{u.id}}{% endif %}{% endif %}{% endfor %}">Привязана</span> <a href="#" id="unlink_uzone" data-id="{{u.id}}">Отвязать</a>
                                            {% endif %}
                                        {% endfor %}
                                    </td>
                                    <td>
                                        <button class="button" data-toggle="dropdownuserzone{{u.id}}">Действие</button>
                                        <div class="dropdown-pane left" id="dropdownuserzone{{u.id}}" data-dropdown style="width:200px;">
                                            <ul class="vertical dropdown menu" data-dropdown-menu>
                                                <li><a href="#" id="show_uzone" data-id="{{u.id}}">Показать</a>
                                                </li>
                                                <li><a href="#" id="rename_userzone" data-id="{{u.id}}">Переименовать</a>
                                                    <ul class="menu">
                                                        <li>
                                                            <input type="text" {% if not u.UserZoneName  or u.UserZoneName == '' %}placeholder="Наименование"{% else %}value="{{u.UserZoneName}}"{% endif %}>
                                                        </li>
                                                    </ul>
                                                </li>
                                                <li><a href="#" id="delete_userzone" data-id="{{u.id}}">Удалить</a></li>
                                                <li>
                                                    <a href="#">Привязать</a>
                                                    <ul class="menu">
                                                        <li><a href="#" data-type="landscape" data-id="{{landscape_id}}" id="link_uzone" data-zoneid="{{u.id}}">Сцена</a>
<ul class="menu">
{% for b in buildings %}
    <li><a href="#" data-type="building" data-id="{{b.id}}" id="link_uzone" data-zoneid="{{u.id}}">{% if not b.BuildingName or b.BuildingName == '' %}{{b.dae_BuildingName}}{% else %}{{b.BuildingName}}{%endif%}</a>
        <ul class="menu">
            {% for f in floors %}
            {% if f.Building_id == b.id %}
            <li><a href="#" data-type="floor" data-id="{{f.id}}" id="link_uzone" data-zoneid="{{u.id}}">{% if not f.FloorName or f.FloorName == '' %}{{f.dae_FloorName}}{% else %}{{f.FloorName}}{% endif %}</a>
                <ul class="menu" style="max-height:200px;overflow-y:scroll;">
                {% for k in kabinet_n_outer %}
                {% if k.Floor_id = f.id %}
                <li><a href="#" data-type="kabinet" data-id="{{k.id}}" id="link_uzone" data-zoneid="{{u.id}}">{% if not k.Kabinet_n_OuterName or k.Kabinet_n_OuterName == '' %}{{k.dae_Kabinet_n_OuterName}}{% else %}{{k.Kabinet_n_OuterName}}{% endif%}</a></li>
                {% endif %}
                {% endfor %}
                </ul>
            </li>
            {% endif %}
            {% endfor %}
        </ul>
    </li>
{% endfor %}        
</ul>
                                                        </li>
                                                    </ul>
                                                </li>
                                                <li>
                                                    <a href="#">Откорректировать высоту</a>
                                                    <ul class="menu">
                                                        <li><a href="#">Минимум</a>
                                                            <ul class="menu">
                                                                <li>
<label for="">Значение
    <input type="number" step="0.01" data-type="min" data-id="{{u.id}}" placeholder="{% for lz in lUserZone%}{% if lz.UserZone_id == u.id %}0{% endif %}{% for bz in bUserZone %}{% if bz.UserZone_id == u.id %}{% for b in buildings%}{% if b.id == bz.Building_id%}{{b.minz}}{% endif %}{%endfor%}{% endif %}{%endfor%}{% for fz in fUserZone %}{% if fz.UserZone_id == u.id%}{% for f in floors%}{% if f.id == fz.Floor_id%}{{f.minz}}{%endif%} {%endfor%}{% endif %}{%endfor%}{% for kz in kUserZone %}{% if kz.UserZone_id == u.id%}{% for k in kabinet_n_outer%}{% if k.id == kz.Kabinet_id%}{{k.minz}}{%endif%}{%endfor%}{%endif%}{% endfor %}{% endfor %}"></li>    
</label>
<button class="button" id="savemin_uzone" data-id="{{u.id}}">Сохранить</button>
                                                            </ul>
                                                        </li>
                                                        <li><a href="#" >Максимум</a>
                                                            <ul class="menu">
                                                                <li>
<label for="">Значение
    <input type="number" step="0.01" data-type="max" data-id="{{u.id}}" placeholder="{% for lz in lUserZone%}{% if lz.UserZone_id == u.id%}3{% endif %}{% for bz in bUserZone %}{% if bz.UserZone_id == u.id %}{% for b in buildings%}{% if b.id == bz.Building_id%}{{b.maxz}}{% endif %}{%endfor%}{% endif %}{%endfor%}{% for fz in fUserZone %}{% if fz.UserZone_id == u.id%}{% for f in floors%}{% if f.id == fz.Floor_id%}{{f.maxz}}{%endif%} {%endfor%}{% endif %}{%endfor%}{% for kz in kUserZone %}{% if kz.UserZone_id == z.id%}{% for k in kabinet_n_outer%}{% if k.id == kz.Kabinet_id%}{{k.maxz}}{%endif%}{%endfor%}{%endif%}{% endfor %}{% endfor %}">
</label>
<button class="button" id="savemax_uzone" data-id="{{u.id}}">Сохранить</button>
                                                                </li>
                                                            </ul>
                                                        </li>
                                                    </ul>
                                                </li>
                                            </ul>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <button class="button" id="new_user">Новая</button>
            </fieldset>
            <fieldset class="large-12 small-12 columns">
                <h3 class="subheader">Список групп</h3>
                <div class="large-12 small-12 columns" id="uzonegrouptable">
                    <table>
                        <thead>
                            <tr>
                                <th>Наименование</th>
                                <th>Действие</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for u in uzonegroups %}
                            <tr>
                                <td>{{u.GroupName}}</td>
                                <td>
                                    <button class="button" data-toggle="uzonegroup{{u.id}}">Действие</button>
                                    <div class="dropdown-pane left" id="uzonegroup{{u.id}}" data-dropdown style="width:200px;">
                                        <ul class="vertical dropdown menu" data-dropdown-menu>
                                            <li>
                                                <a href="#" id="showzonegroup" data-id="{{u.id}}">Показать</a>
                                            </li>
                                            <li>
                                                <a href="#" id="renamezonegroup" data-id="{{u.id}}">Переименовать</a>
                                                <ul class="menu">
                                                    <li>
                                                        <input type="text" {% if not u.GroupName  or u.GroupName == '' %}placeholder="Наименование"{% else %}value="{{u.GroupName}}"{% endif %}>
                                                    </li>
                                                </ul>
                                            </li>
                                            <li><a href="#" id="deleteuzonegroup" data-id="{{u.id}}">Удалить</a></li>
                                            <li>
                                                <a href="#">Привязать зону пользователя</a>
                                                <ul class="menu">
                                                    {% for uz in uzoneswithoutgroups %}
                                                        <li><a href="#" data-id="{{uz.id}}" data-group="{{u.id}}" id="linkuzonetogroup">{% if uz.UserZoneName %}{{uz.UserZoneName}}{% else %}{{uz.id}}{% endif %}</a></li>
                                                    {% endfor %}
                                                </ul>
                                            </li>
                                            <li>
                                                <a href="#">Отвязать зону пользователя</a>
                                                <ul class="menu">
                                                    {% for guz in uzonegroupuzones %}
                                                        {% if guz.GroupUserZone_id == u.id %}
{% for uz in uzones %}                                                            
    {% if uz.id == guz.UserZone_id%}
        <li><a href="#" data-id="{{uz.id}}" data-group="{{guz.GroupUserZone_id}}" id="unlinkuzonetogroup">{% if uz.UserZoneName%}{{uz.UserZoneName}}{% else %}{{uz.id}}{% endif %}</a></li>
    {% endif %}
{%endfor%}
                                                        {% endif %}
                                                    {% endfor %}
                                                </ul>
                                            </li>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <button class="button" id="new_uzonegroup">новая</button>
            </fieldset>
            <label class="user_lessvert label alert" style="display:none;">Мало вершин</label>
        </div>
		<!-- **********шейдеры ******-->
		<!--************************-->
		<script type="x-shader/x-vertex" id="vertexShader">

			varying vec3 vWorldPosition;
			void main() {

				vec4 worldPosition = modelMatrix * vec4( position, 1.0 );
				vWorldPosition = worldPosition.xyz;

				gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
			}
		</script>

		<script type="x-shader/x-fragment" id="fragmentShader">

			uniform vec3 topColor;
			uniform vec3 bottomColor;
			uniform float offset;
			uniform float exponent;

			varying vec3 vWorldPosition;

			void main() {

				float h = normalize( vWorldPosition + offset ).y;
				gl_FragColor = vec4( mix( bottomColor, topColor, max( pow( h, exponent ), 0.0 ) ), 1.0 );

			}
		</script>
		<!--************************-->
<!--***********буфер**************-->
		<!--************************-->
	<script>
    //user_id
    var user_id = {{username}};
    //панель инструментов
    $.getScript("/static/js/additional/instrument_panel.js");
    //массив объектов
    var colladaObjects = {};

	//************************
	//************************
	//сцена, фон, сетка, камера
	//инициализация
	//************************
	//************************

    //глобальные переменные
	var dae;
	var camera;
	var spotLight;
	var cameraTarget;
	var renderer;
	var scene;
	// глобальный объект
	var center;
    // vertices zone
    var vertices = [];
    var landscape_id = '{{landscape_id}}';
    // объект с параметрами selected building, floor, kabinet
    var selObject = {};

	function init(){

    /*сцена, камера */
    scene = new THREE.Scene();
    /*camera = new THREE.OrthographicCamera( window.innerWidth / - 2, window.innerWidth / 2, window.innerHeight / 2, window.innerHeight / - 2, 1, 1000 );*/
    camera =  new THREE.PerspectiveCamera(85, window.innerWidth/window.innerHeight, .1, 1000);
    renderer = new THREE.WebGLRenderer({antialias:true});
    
    /*рендерер;*/
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMapEnabled= true;
    renderer.shadowMapType = THREE.PCFSoftShadowMap;
    
    /*оси*/
    axis = new THREE.AxisHelper(30);
    scene.add(axis);

    /* сетка */
    grid = new THREE.GridHelper(100, 25);
    color = new THREE.Color("rgb(255, 0, 0)");
    grid.setColors(color, 0x000000);
    grid.rotation.x = -0.5* Math.PI
    /*scene.add(grid);*/
    
    //шейдер неба
    var vertexShader = document.getElementById( 'vertexShader' ).textContent;
    var fragmentShader = document.getElementById( 'fragmentShader' ).textContent;
    var uniforms = {
        topColor:      { type: "c", value: new THREE.Color(0x000000) },
        bottomColor: { type: "c", value: new THREE.Color( 0x262626 ) },
        offset:         { type: "f", value: 100 },
        exponent:     { type: "f", value: 0.7 }
    }

    //сфера неба
    var skyGeo = new THREE.SphereGeometry( 300, 32, 15 );
    var skyMat = new THREE.ShaderMaterial( { vertexShader: vertexShader, fragmentShader: fragmentShader, uniforms: uniforms, side: THREE.BackSide } );

    var sky = new THREE.Mesh( skyGeo, skyMat );
    scene.add( sky );

    /* add collada import */
    var loader = new THREE.ColladaLoader();
    /*loader.options.convertUpAxis = true;*/
    loader.load( '/models/{{link}}', function ( collada ) {
        //расширение bounding box по размерам внутренних элементов
        var getBoundingBox = function(node, dae_elem, indae_elem){
            if (indae_elem == 1){
                if(node.parent.children){
                    for (var i = 0; i < node.parent.children.length; i++){
                        inner_elem = node.parent.children[i]
                        var bbox = new THREE.Box3().setFromObject(inner_elem);
                        inner_elem.BoxMin = bbox['min'];
                        inner_elem.BoxMax = bbox['max'];
                        if(dae_elem.BoxMin['x'] > inner_elem.BoxMin['x']){
                            dae_elem.BoxMin['x'] = inner_elem.BoxMin['x'];
                        }
                        if(dae_elem.BoxMin['y'] > inner_elem.BoxMin['y']){
                            dae_elem.BoxMin['y'] = inner_elem.BoxMin['y'];
                        }
                        if(dae_elem.BoxMin['z'] > inner_elem.BoxMin['z']){
                            dae_elem.BoxMin['z'] = inner_elem.BoxMin['z'];
                        }
                        if (dae_elem.BoxMax['x'] < inner_elem.BoxMax['x']){
                            dae_elem.BoxMax['x'] = inner_elem.BoxMax['x'];
                        }
                        if (dae_elem.BoxMax['y'] < inner_elem.BoxMax['y']){
                            dae_elem.BoxMax['y'] = inner_elem.BoxMax['y'];
                        }
                        if (dae_elem.BoxMax['z'] < inner_elem.BoxMax['z']){
                            dae_elem.BoxMax['z'] = inner_elem.BoxMax['z'];
                        }
                    } 
                }
            }
            if (node.children){
                for (var i = 0; i < node.children.length; i++){
                    if (node.children[i].name == dae_elem.name) {
                        getBoundingBox(node.children[i], dae_elem, 1);
                    }
                    getBoundingBox(node.children[i], dae_elem, 0);
                }
            }
        }

        //функция поиска центра collada объекта на оси координат
        var getCenter = function(obj){
            minx = obj.min.x;
            miny = obj.min.y;
            minz = obj.min.z;

            maxx = obj.max.x;
            maxy = obj.max.y;
            maxz = obj.max.z;

            x = (minx - maxx);
            x = x - 2*x;

            y = (miny - maxy);
            y = y - 2*y;

            z = (minz - maxz);
            z = z - 2*z;

            a = {}
            a['x'] = minx + x/2;
            a['y'] = miny + y/2;
            a['z'] = minz + z/2;
            return a;
        }

    	//gls.dae
    	var dae = collada.scene;
    	dae.position.x = {{sceneop.dae_position_x|stringformat:"f"}}
        dae.position.y = {{sceneop.dae_position_y|stringformat:"f"}}
        dae.position.z = {{sceneop.dae_position_z|stringformat:"f"}}
    	dae.scale.set(1,1,1);
    	dae.rotation.z = {{sceneop.dae_rotation_z|stringformat:"f"}};
    	dae.rotation.x = {{sceneop.dae_rotation_x|stringformat:"f"}};
        dae.rotation.y = {{sceneop.dae_rotation_y|stringformat:"f"}};
    	scene.add(dae);

        //наполняем именами объекты  building, floor, kabinet dae,
        //наполняем цвета объектов из БД
        {% for b in buildings %}
            fillObjectName(dae.children[0], '{{b.dae_BuildingName}}', '{{b.BuildingName}}', '{% for bc in bcolor %}{% if bc.Building_id == b.id %}{{bc.bcolor}}{% endif %}{% endfor %}');
        {% endfor %}

        {% for f in floors %}
            fillObjectName(dae.children[0], '{{f.dae_FloorName}}', '{{f.FloorName}}', '{% for fc in fcolor %}{% if fc.Floor_id == f.id%}{{fc.fcolor}}{%endif%}{% endfor %}');
        {% endfor %}

        {% for k in kabinet_n_outer %}
            fillObjectName(dae.children[0], '{{k.dae_Kabinet_n_OuterName}}', '{{k.Kabinet_n_OuterName}}', '{% for kc in kcolor %}{% if kc.Kabinet_id == k.id %}{{kc.kcolor}}{% endif %}{% endfor %}');
        {% endfor %}
        function fillObjectName(dae, text, text2, dbColor){
            if (dae.children){
                for (var i = 0; i < dae.children.length; i++){
                    if(dae.children[i].name == text){
                        dae.children[i].dbName = text2;
                        if (dbColor.length > 0){
                            dae.children[i].dbColor = dbColor;
                        } else if (dbColor.length == 0 && text.indexOf('floor') != -1){
                            dae.children[i].dbColor = '008080';
                        } else if (dbColor.length == 0 && text.indexOf('kabinet') != -1){
                            dae.children[i].dbColor = '193434';
                        } else if (dbColor.length == 0 && text.indexOf('building') != -1){
                            dae.children[i].dbColor = '6b002b';
                        }
                    }
                    fillObjectName(dae.children[i], text, text2, dbColor);
                }
            }
        }
        //****************************
        //**заполняем массив элементов сцены
        //****************************

        //**дерево
        colladaObjects['landscape'] = [];
        //**наполняем landscape
        colladaObjects['landscape'].push(dae['children'][0]['children'][0]);
        colladaObjects['landscape'][0].name = colladaObjects['landscape'][0]['parent']['name'];
            // ищем центр landscape
            lndscp = dae;
            var bbox = new THREE.Box3().setFromObject(lndscp);
            landscape = colladaObjects['landscape'][0];
            a = getCenter(bbox);
            landscape.Center = new THREE.Vector3(a['x'], a['y'], a['z']);
        //**наполняем building
        var no = 0;
        $.each(colladaObjects['landscape'][0].parent.children, function(value){
            var landscape = colladaObjects['landscape'][0].parent.children[value];
            if (landscape.name.indexOf('building') != -1){
                colladaObjects['landscape'][0].children.push(landscape.children[0]);
                colladaObjects['landscape'][0]['children'][no]['name'] = colladaObjects['landscape'][0]['children'][no]['parent']['name'];
                    // ищем центр building
                    bld = colladaObjects['landscape'][0].children[no];
                    var bbox = new THREE.Box3().setFromObject(bld);
                    bld.BoxMin = bbox['min'];
                    bld.BoxMax = bbox['max'];
                    getBoundingBox(colladaObjects['landscape'][0], bld, 0);
                    a = getCenter(bbox);
                    bld.Center = new THREE.Vector3(a['x'], a['y'], a['z']);
                building = colladaObjects['landscape'][0]['children'][no].parent.children;
                //**наполняем floor
                var noFloor = 0
                $.each(building, function(value){
                    if (building[value].name.indexOf('floor') != -1){
                        colladaObjects['landscape'][0].children[no].children.push(building[value].children[0]);
                        colladaObjects['landscape'][0].children[no].children[noFloor].name = building[value].name;
                            // ищем центр floor
                            flr = colladaObjects['landscape'][0].children[no].children[noFloor];
                            var bbox = new THREE.Box3().setFromObject(flr);
                            flr.BoxMin = bbox['min'];
                            flr.BoxMax = bbox['max'];
                            getBoundingBox(colladaObjects['landscape'][0], flr, 0);
                            a = getCenter(bbox);
                            flr.Center = new THREE.Vector3(a['x'], a['y'], a['z']);
                        //** наполняем kabinet и outer
                        floor = colladaObjects['landscape'][0]['children'][no]['children'][noFloor].parent.children;
                        var noKabinet = 0;
                        $.each(floor, function(value){
                            if(floor[value].name.indexOf('kabinet') != -1){
                                colladaObjects['landscape'][0].children[no]['children'][noFloor].children.push(floor[value].children[0]);
                                colladaObjects['landscape'][0].children[no]['children'][noFloor].children[noKabinet].name = floor[value].name;
                                    // ищем центр kabinet
                                    kbnt = colladaObjects['landscape'][0].children[no]['children'][noFloor].children[noKabinet];
                                    var bbox = new THREE.Box3().setFromObject(kbnt);
                                    kbnt.BoxMin = bbox['min'];
                                    kbnt.BoxMax = bbox['max'];
                                    getBoundingBox(colladaObjects['landscape'][0], kbnt,0);
                                    a = getCenter(bbox);
                                    kbnt.Center = new THREE.Vector3(a['x'], a['y'], a['z']);
                                //** наполняем wall
                                kabinet = colladaObjects['landscape'][0]['children'][no]['children'][noFloor]['children'][noKabinet].parent.children;
                                var noWall = 0;
                                $.each(kabinet, function(value){
                                    if(kabinet[value].name.indexOf('wall') != -1){
                                        colladaObjects['landscape'][0].children[no]['children'][noFloor].children[noKabinet].children.push(kabinet[value].children[0]);
                                        colladaObjects['landscape'][0].children[no]['children'][noFloor].children[noKabinet].children[noWall].name = kabinet[value].name
                                            // ищем центр wall
                                            wall = colladaObjects['landscape'][0].children[no]['children'][noFloor].children[noKabinet].children[noWall]
                                            var bbox = new THREE.Box3().setFromObject(wall);
                                            wall.BoxMin = bbox['min'];
                                            wall.BoxMax = bbox['max'];
                                            a = getCenter(bbox);
                                            wall.Center = new THREE.Vector3(a['x'], a['y'], a['z']);
                                        noWall += 1;
                                    }
                                });
                                noKabinet += 1;
                            }
                            if (floor[value].name.indexOf('outer') != -1){
                                colladaObjects['landscape'][0].children[no]['children'][noFloor].children.push(floor[value].children[0]);
                                colladaObjects['landscape'][0].children[no]['children'][noFloor].children[noKabinet].name = floor[value].name;
                                    // ищем центр outer
                                    outr = colladaObjects['landscape'][0].children[no]['children'][noFloor].children[noKabinet];
                                    var bbox = new THREE.Box3().setFromObject(outr);
                                    outr.BoxMin = bbox['min'];
                                    outr.BoxMax = bbox['max'];
                                    a = getCenter(bbox);
                                    outr.Center = new THREE.Vector3(a['x'], a['y'], a['z']);
                                noKabinet += 1
                            }
                        });
                        noFloor += 1;
                    }
                });
                no += 1;
            }
            // наполняем light
            if (landscape.name.indexOf('light') != -1){
                colladaObjects['landscape'][0].children.push(landscape.children[0]);
                colladaObjects['landscape'][0]['children'][no]['name'] = colladaObjects['landscape'][0]['children'][no]['parent']['name'];
                var light = colladaObjects['landscape'][0]['children'][no];
                    // ищем центр light
                    lght = colladaObjects['landscape'][0].children[no];
                    var bbox = new THREE.Box3().setFromObject(lght);
                    a = getCenter(bbox);
                    lght.Center = new THREE.Vector3(a['x'], a['y'], a['z']);
                no += 1;
            }
        });

        //****************************
        //**настройки сцены по умолчанию
        //****************************
    	//landscape 
    	plane = colladaObjects['landscape'][0];
        /*plane.receiveShadow = true;*/
    	setMaterialObject(plane, new THREE.MeshBasicMaterial({ color: {% for lc in lcolor %}{% if lc.LoadLandscape_id == landscape_id %}parseInt('0x'+ '{{lc.lcolor}}'){% else %}0x803131{% endif %}{% endfor %}}));
    	//building
        $.each(colladaObjects['landscape'][0].children, function(value){
            if (colladaObjects['landscape'][0].children[value].name.indexOf('building') != -1){
                building = colladaObjects['landscape'][0].children[value];
                bcolor = building.parent['dbColor'];
                building.visible = false;
                $.each(building.children, function(value){
                    //floor
                    floor = building.children[value];
                    fcolor = floor.parent['dbColor'];
                    setMaterialObject(floor, new THREE.MeshBasicMaterial({color: parseInt('0x'+ fcolor), transparent:true}));
                    /*floor.receiveShadow = true;*/
                    /*floor.castShadow = true;*/
                    //kabinet n outer
                    $.each(floor.children, function(value){
                        if (floor.children[value].name.indexOf('outer') != -1){
                            outer = floor.children[value];
                            /*outer.castShadow = true;*/
                            setMaterialObject(outer, new THREE.MeshLambertMaterial({color: parseInt('0x'+bcolor), transparent:true}));
                        } else if (floor.children[value].name.indexOf('kabinet') != -1){
                            kabinet = floor.children[value];
                            kcolor = kabinet.parent['dbColor'];
                            kabinet.visible = false;
                            //wall
                            $.each(kabinet.children, function(value){
                                wall = kabinet.children[value];
                                /*wall.castShadow = true;*/
                                setMaterialObject(wall, new THREE.MeshLambertMaterial({color: parseInt('0x'+kcolor), transparent:true}));
                            });
                        }
                    });
                });
            }
            if (colladaObjects['landscape'][0].children[value].name.indexOf('light') != -1){
                light = colladaObjects['landscape'][0].children[value];
                light.visible = false;
                a = light.Center;
                spotLight = new THREE.SpotLight(0xffffff);
                spotLight.castShadow = true;
                spotLight.position.set (a['x'], a['y'], a['z']);
                spotLight.target.position.set(a['x'], a['y'], a['z']{% if sceneop.light_target_symbol == 1 %}-{% else %}+{% endif%} 60);
                this.lightX = 20;
                this.lightY = 35;
                this.lightZ = 40;
                this.intensity = 5;
                this.decay = 8.5;   
                this.distance = 87;
                this.angle = 0.54;
                this.exponent = 0;
                this.shadowCameraNear = 10;
                this.shadowCameraFar = 100;
                this.shadowCameraFov = 50;
                this.shadowCameraVisible=false;
                this.shadowMapWidth=1028;
                this.shadowMapHeight=1028;
                this.shadowBias=0;
                this.shadowDarkness=0.5;
                spotLight.target.updateMatrixWorld();
                scene.add(spotLight);
            }
        });

        //***********************
        //** фунции управления элементами
        //*******************
        
        //add raycaster and mouse as 2D vector
        raycaster = new THREE.Raycaster();
        mouse = new THREE.Vector2();
        //добавляем слушатель событи одного клика для назначения зон
        document.getElementById('webGL-container').addEventListener('click', onVerticeAdd, false);

        //функция добавить вершну к зоне входа
        function onVerticeAdd(event){
            if ($('#new').text()== 'Остановить'){
                addVertice(vertices, event);
            }
            if ($('#new_exclude').text()=='Остановить'){
                addVertice(vertices, event);
            }
            if ($('#new_user').text()=='Остановить'){
                addVertice(vertices, event);
            }
            if ($('#newobject').text()=='Остановить'){
                addVertice(vertices, event);
            }
        }

        function addVertice(arr, event){
            event.preventDefault();
            mouse.x = (event.clientX/ renderer.domElement.width) * 2 - 1;
            mouse.y = -(event.clientY/ renderer.domElement.height) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            var vector = new THREE.Vector3();
            vector.set(
                (event.clientX / renderer.domElement.width) * 2 - 1,
                - (event.clientY / renderer.domElement.height) * 2 + 1,
                0.5);
            vector.unproject(camera);
            var dir = vector.sub(camera.position).normalize();
            var distance = - camera.position.z / dir.z;
            var pos = camera.position.clone().add(dir.multiplyScalar(distance));
            camx = camera.position.x;
            camy = camera.position.y;
            dirx = dir.x;
            diry = dir.y
            arr.push({x: dirx+camx, y: diry+camy, id: landscape_id});
        }


        //add event listener for mouse and calls function when activated
        document.getElementById('webGL-container').addEventListener('dblclick', onDocumentMouseDown, false);
        document.getElementById('webGL-container').addEventListener('touchstart', onDocumentTouchStart, false);

        function onDocumentTouchStart(event){
            event.preventDefault();
            event.clientX = event.touches[0].clientX;
            event.clientY = event.touches[0].clientY;
            onDocumentMouseDown(event);
        }

        var selectedFloor;
        var intersectsObjects;
        function onDocumentMouseDown(event){
            var floor = {};
            var building = {};
            var kabinet = {};
            

            event.preventDefault();
            mouse.x = (event.clientX/ renderer.domElement.width) * 2 - 1;
            mouse.y = -(event.clientY/ renderer.domElement.height) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);

            //ищем Objects
            $.each(Objects, function(index){
                $.each(Objects[index]['objects'], function(ind){
                    a = raycaster.intersectObject(Objects[index]['objects'][ind]['mesh']);
                    if (intersectsObjects){
                        //скрываем objectwindow
                        $('#objectwindow').css({display: 'none'});
                    }
                    if (a.length > 0){
                        if( intersectsObjects ){
                            //уменьшаем размер сферы ранее выбранной, убираем objectwindow
                            scale = intersectsObjects[0].object.scale.x;
                            intersectsObjects[0].object.scale.set(scale/2, scale/2, scale/2);
                            $('#objectwindow').css({display: 'none'});
                        }
                        obj = Objects[index]['objects'][ind]
                        Name = obj['Name'];
                        Type_id = Objects[index]['type_id'];
                        Id = obj['id'];
                        intersectsObjects = a;
                        intersectsObjects[0].Name = Name;
                        intersectsObjects[0].Type_id = parseInt(Type_id);
                        intersectsObjects[0].Id = parseInt(Id);
                        scale = intersectsObjects[0].object.scale.x;
                        intersectsObjects[0].object.scale.set(scale*2, scale*2, scale*2);
                        //показываем objectwindow
                        $('#objectwindow').css({display: 'block'});
                        $('#objectwindow').css({top: event.clientY, left: event.clientX});
                        //показываем информацию об объекте
                        parameters = {};
                        parameters['landscape_id'] = landscape_id;
                        parameters['obj_id'] = Id;
                        parameters['obj_type'] = Type_id;
                        parameters['method'] = 'getobjectinfo';
                        getInfo(parameters);
                        return false;
                    }
                });
            });

            //функция показать информацию о объекте
            function getInfo(parameters){
                $('#objectwindow').html('');
                $.ajax({
                    type: "POST",
                    url: "/incomezonedefine/"+landscape_id,
                    data: JSON.stringify(parameters),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    async: true,
                    success: function(data, textStatus, jqXHR){
                        $('#objectwindow').html(data['string']);
                    }
                });
            }

            //панель Objects
            console.log(landscape_id);

            //ищем building по floor
            ElemLookUp(colladaObjects['landscape'][0], 'building', building, 0);
            
            nofloor = 0;
            $.each(building, function(index){
                ElemLookUp(building[index], 'floor', floor, nofloor);
                $.each(floor, function(){
                    nofloor += 1;
                });
            });

            //передаем floor перехватчику
            var intersects = {};
            no = 0;
            $.each(floor, function(index){
                intersects[no] = raycaster.intersectObject(floor[index]);
                no += 1;
            });

            //наполняем popup floor            
            $('.popup').empty();

            $.each(intersects, function(index){
                if (intersects[index].length > 0) {
                    dae_elem = intersects[index][0].object.parent.parent.name;
                    lookUpBuilding(colladaObjects['landscape'][0], dae_elem);
                    lookUpFloor(colladaObjects['landscape'][0], dae_elem, {});
                    lookUpKabinet(colladaObjects['landscape'][0], dae_elem, {});
                    /*cameraToggle(colladaObjects['landscape'][0], dae_elem);*/
                    flr = intersects[index][0].object.parent.parent
                    $('.popup').empty();
                    $.each(flr.children, function(index){
                        if (flr.children[index].name.indexOf('floor') != -1){
                            if (flr.children[index].dbName != 'None'){
                                $('.popup').append('<li class="tabs-title" style="width:100%;" data-id="' +flr.children[index].name +'"><a href="#panel2v">'+ flr.children[index].dbName +'</a></li>');
                            } else {
                                $('.popup').append('<li class="tabs-title" style="width:100%;" data-id="' +flr.children[index].name +'"><a href="#panel2v">'+ flr.children[index].name +'</a></li>');
                            }
                        }
                    });
                    return false;
                }
            });

            //событие нажатие переключение к floor
            $('.popup a').on('click', function(){
                dae_elem = $(this).parent().attr('data-id');
                selectedFloor = dae_elem;
                lookUpBuilding(colladaObjects['landscape'][0], dae_elem);
                lookUpFloor(colladaObjects['landscape'][0], dae_elem, {});
                lookUpKabinet(colladaObjects['landscape'][0], dae_elem, {});
                /*cameraToggle(colladaObjects['landscape'][0], dae_elem);*/                
            });

            nokabinet = 0;
            //ищем kabinet по floor
            $.each(floor, function(index){
                if (floor[index].name == selectedFloor){
                    ElemLookUp(floor[index], 'kabinet', kabinet, nokabinet);
                    nokabinet += 1;
                }
            });


            //передаем kabinet перехватчику
            var intersectsKab = {};
            no = 0;
            $.each(kabinet, function(index){
                intersectsKab[no] = raycaster.intersectObject(kabinet[index]);
                no += 1;
            });

            no = 0;
            //наполняем popup kabinet
            $.each(intersectsKab, function(index){
                if (intersectsKab[index].length > 0) {
                    if (selectedFloor == kabinet[index].parent.parent.name){
                        dae_elem = intersectsKab[index][0].object.name;
                        //при выборе кабинета, отображать метки на этаже вне этого кабинета
                        f = intersectsKab[index][0].object.parent.parent.name;
                        lookUpBuilding(colladaObjects['landscape'][0], dae_elem);
                        lookUpFloor(colladaObjects['landscape'][0], dae_elem, {});
                        lookUpKabinet(colladaObjects['landscape'][0], dae_elem, {});
                        /*cameraToggle(colladaObjects['landscape'][0], dae_elem);*/
                        $('.popup').empty();
                        $.each(kabinet, function(index){
                            if (kabinet[index].parent.dbName != 'None'){
                                $('.popup').append('<li class="tabs-title" style="width:100%;" data-id="' + kabinet[index].name +'" data-floor="'+ f +'"><a href="#panel2v">'+ kabinet[index].parent.dbName +'</a></li>');    
                            } else {
                                $('.popup').append('<li class="tabs-title" style="width:100%;" data-id="' + kabinet[index].name +'" data-floor="'+ f +'"><a href="#panel2v">'+ kabinet[index].name +'</a></li>');
                            }
                        });
                    }
                    return false;
                }
            });
        }
        //событие нажатие переключение kabinet
        $('.popup').delegate('a', 'click', function(){
            dae_elem = $(this).parent().attr('data-id');
            //при выборе кабинета, отображать метки на этаже вне этого кабинета
            dae_floor = $(this).parent().attr('data-floor')
            lookUpBuilding(colladaObjects['landscape'][0], dae_elem);
            lookUpFloor(colladaObjects['landscape'][0], dae_elem, {});
            lookUpKabinet(colladaObjects['landscape'][0], dae_elem, {});
            /*cameraToggle(colladaObjects['landscape'][0], dae_elem);*/
        });

        function ElemLookUp(node, text, object, no){
            if (node.children){
                for(var i = 0; i < node.children.length; i++){
                    if(node.children[i].name.indexOf(text) != -1){
                        object[no] = node.children[i];
                        no += 1;
                    }
                    ElemLookUp(node.children[i], text, object, no);
                }
            }
        }

        //высокое, низкое качество графики
        $('#high').on('click', function(){
            plane = colladaObjects['landscape'][0];
            setMaterialObject(plane, new THREE.MeshPhongMaterial({ color: {% for lc in lcolor %}{% if lc.LoadLandscape_id == landscape_id %}parseInt('0x'+ '{{lc.lcolor}}'){% else %}0x803131{% endif %}{% endfor %}}));
            toggleFloorQuality(dae.children[0], 'high');
        });

        $('#low').on('click', function(){
            plane = colladaObjects['landscape'][0];
            setMaterialObject(plane, new THREE.MeshBasicMaterial({ color: {% for lc in lcolor %}{% if lc.LoadLandscape_id == landscape_id %}parseInt('0x'+ '{{lc.lcolor}}'){% else %}0x803131{% endif %}{% endfor %}}));
            toggleFloorQuality(dae, 'low');
        });

        function toggleFloorQuality(dae, ToggleTo){
            if (dae.children){
                for (var i = 0; dae.children.length > i; i++){
                    if (dae.children[i].name.indexOf('floor') != -1 && dae.children[i].colladaId == null){
                        fcolor = dae.children[i].parent['dbColor'];
                        floor = dae.children[i];
                        if (ToggleTo == 'high'){
                            setMaterialObject(floor, new THREE.MeshPhongMaterial({color: parseInt('0x'+ fcolor), transparent:true}));
                        }
                        else if(ToggleTo == 'low'){
                            setMaterialObject(floor, new THREE.MeshBasicMaterial({color: parseInt('0x'+ fcolor), transparent:true}));
                        }
                    }
                    toggleFloorQuality(dae.children[i], ToggleTo);
                }
            }
        }

        //видимость
        $('#turn_off').on('click', function(){
            var dae_elem = $('.cursor_box span').text();
            togleVisibleOff(colladaObjects['landscape'][0], dae_elem);
        });

        $('#turn_on').on('click', function(){
            var dae_elem = $('.cursor_box span').text();
            togleVisibleOn(colladaObjects['landscape'][0], dae_elem);
        });

        var togleVisibleOn = function(node, dae_elem){
            defaultToggle(node);
            if (node.children){
                for (var i = 0; i < node.children.length; i++){
                    if (node.children[i].name == dae_elem){
                        togleVisible(node.children[i], true);
                    }
                    togleVisibleOn(node.children[i], dae_elem);
                }
            }
        }

        var togleVisibleOff = function(node, dae_elem){
            if (node.children){
                for (var i = 0; i < node.children.length; i++){
                    if (node.children[i].name == dae_elem){
                        togleVisible(node.children[i], false);
                    }
                    togleVisibleOff(node.children[i], dae_elem);
                }
            }
        }

        //скрыть видимость элементов по умолчанию невидимых
        var defaultToggle = function(node){
            if (node.name.indexOf('building') != -1 ){
                node.visible = false;
            }
            if (node.name.indexOf('kabinet') != -1){
                node.visible = false;
            }
            for (var i = 0; i < node.children.length; i++){
                if (node.children[i].name.indexOf('kabinet') != -1){
                    node.children[i].visible = false;
                }
                defaultToggle(node.children[i]); 
            }
        }

        //прозрачность
        $('#building_opacity').attrchange({
            trackValues: false,
            callback: function(event){
                var dae_elem = $('.cursor_box span').text();
                opacityFinder(colladaObjects['landscape'][0], dae_elem, $(this).attr('value'));
            }
        });

        var opacityFinder = function(node, dae_elem, value){
            if (node.children){
                for(var i=0; i < node.children.length; i++){
                    if(node.children[i].name == dae_elem){
                        togleOpacity(node.children[i], value);
                    }
                    opacityFinder(node.children[i], dae_elem, value);
                }
            }
        }
        //кнопка "камера"
        $('.camera').on('click', function(){
            var dae_elem = $('.cursor_box span').text();
            cameraToggle(colladaObjects['landscape'][0], dae_elem);
        });

        //кнопка "выбрать"
        $('.select_object').on('click', function(){
            var dae_elem = $('.cursor_box span').text();
            lookUpBuilding(colladaObjects['landscape'][0], dae_elem);
            lookUpFloor(colladaObjects['landscape'][0], dae_elem, {});
            lookUpKabinet(colladaObjects['landscape'][0], dae_elem, {});
            cameraToggle(colladaObjects['landscape'][0], dae_elem);
        });

        //поиск зданий
        var lookUpBuilding = function(node, dae_elem){
            if (node.children){
                for (var i=0; i < node.children.length; i++){
                    if (node.children[i].name.indexOf('building') != -1){
                        building = node.children[i].name;
                        if (building == dae_elem){
                            opacityFinder(colladaObjects['landscape'][0], dae_elem, 0.3);
                            //показываем скрытые объекты
                            togleVisibleOn(colladaObjects['landscape'][0], building);
                            //отметка привязанных зон в таблице
                            colored(building);
                            coloredexclude(building);
                            //запрос вершин здания и вершин привязанных к нему объектов
                            getVertices(building, node.children[i]);
                            //показать привязанные к строению объекты
                            if ($('#showobjects')[0].checked==true){
                                objecttype = parseInt($('#objecttype option:selected')[0].value);
                                showObjectType('showlinkedobjectsbuilding', objecttype, building);
                            }
                            return false;
                        }
                    }
                    lookUpBuilding(node.children[i], dae_elem);
                }   
            }
        }

        //поиск этажей
        var lookUpFloor = function(node, dae_elem, floors){
            defaultToggle(node);
            if (node.children){
                for (var i=0; i < node.children.length; i++){
                    if(node.children[i].name.indexOf('floor') != -1){
                        if(node.children[i].name == dae_elem){
                            name = dae_elem.split('_');
                            cur = {}
                            cur['curNum'] = parseInt(name[1].substring(0, 3));
                            cur['curName'] = node.children[i].name;
                            //ищем outer
                            for (var q=0; q < node.children[i].children.length; q++){
                                name = node.children[i].children[q].name
                                if(name.indexOf('outer') != -1){cur['outrName'] = name}
                            }
                            for (var j=0; j < node.children.length; j++){
                                var name = node.children[j].name;
                                if(name.indexOf('floor') != -1) {
                                    name = name.split('_');
                                    number = parseInt(name[1].substring(0, 3));
                                    floors[node.children[j].name] = number;
                                }
                            }
                            $.each(floors, function(value){
                                //скрываем этажи, выше текущего
                                if (floors[value] > cur['curNum']) {
                                    togleVisibleOff(colladaObjects['landscape'][0], value);
                                }
                                //уменьшаем прозрачность этажей, ниже текущего
                                if (floors[value] < cur['curNum']) {
                                    opacityFinder(colladaObjects['landscape'][0], value, 0.1);
                                }
                                //скрываем outer текущего этажа
                                if (floors[value] == cur['curNum']){
                                    togleVisibleOn(colladaObjects['landscape'][0], cur['curName']);
                                    //скрываем outer
                                    togleVisibleOff(colladaObjects['landscape'][0], cur['outrName']);
                                    //устанавливаем прозрачность текущего этажа
                                    opacityFinder(colladaObjects['landscape'][0], cur['curName'], 1);
                                        //отметка привязанных зон в таблице
                                        colored(cur['curName']);
                                        coloredexclude(cur['curName']);
                                        //запрос вершин здания и вершин привязанных к нему объектов
                                        getVertices(cur['curName'], node.children[i]);
                                        return false;
                                }
                            })
                            max = Math.max.apply(Math, floors);
                            min = Math.min.apply(Math, floors);
                            //показать привязанные к этажу объекты
                            if ($('#showobjects')[0].checked==true){
                                objecttype = parseInt($('#objecttype option:selected')[0].value);
                                showObjectType('showlinkedobjectsfloor', objecttype, dae_elem);
                            }
                            return false;
                        }
                    }
                    lookUpFloor(node.children[i], dae_elem, floors);
                }
            }
        }
        //поиск кабинетов
        var lookUpKabinet = function(node, dae_elem, kabinets){
            defaultToggle(node);
            if (node.children){
                for(var i = 0; i < node.children.length; i++){
                    if (node.children[i].name.indexOf('kabinet') != -1){
                        if(node.children[i].name == dae_elem){
                            //включаем поиск этажей
                            lookUpFloor(colladaObjects['landscape'][0], node.parent.name, {});
                            curName = node.children[i].name;
                            for (var j = 0; j < node.children.length; j++){
                                var name = node.children[j].name;
                                if(name.indexOf('kabinet') != -1) {
                                    name = name.split('_');
                                    kabinets[node.children[j].name] = node.children[j].name;
                                }
                            }
                            $.each(kabinets, function(value){
                                if (kabinets[value] != curName){
                                    //уменьшаем прозрачность других кабинетов
                                    togleVisibleOff(colladaObjects['landscape'][0], value);
                                }
                                //устанавливаем прозрачность текущего кабинета
                                opacityFinder(colladaObjects['landscape'][0], curName, 0.8);
                                    //отметка привязанных зон в таблице
                                    colored(curName);
                                    coloredexclude(curName);
                                    //запрос вершин здания и вершин привязанных к нему объектов
                                    getVertices(curName, node.children[i]);
                                    return false;
                            });
                            //показать привязанные к кабинету объекты
                            if ($('#showobjects')[0].checked==true){
                                objecttype = parseInt($('#objecttype option:selected')[0].value);
                                showObjectType('showlinkedobjectskabinet', objecttype, dae_elem);
                            }
                            return false;
                        }
                    }
                    lookUpKabinet(node.children[i], dae_elem, kabinets);
                }
            }
        }

        var cameraToggle = function(node, dae_elem){
            if(node.children){
                for (var i = 0; i < node.children.length; i++){
                    if (node.children[i].name == dae_elem){
                        x = node.children[i].Center.x;
                        y = node.children[i].Center.y;
                        z = node.children[i].Center.z;
                        camera.LookAtNew = new THREE.Vector3(rdr(x), rdr(y), rdr(z));
                        controls.TarNew = new THREE.Vector3(rdr(x), rdr(y), rdr(z));
                    }
                    cameraToggle(node.children[i], dae_elem);
                }
            }
        }

        function rdr(val){
            return parseFloat(Math.round(val).toFixed(2));
        }
    });

    //изменить материал для обектов
    var setMaterialObject = function(obj, material) {
    	obj.material = material;
	}

    //изменить материал для дочерних объектов
    var setMaterialNode = function(node, material) {
		node.material = material;
		if (node.children) {
			for (var i = 0; i < node.children.length; i++) {
  				setMaterialNode(node.children[i], material);
			}
		}
	}

    //изменение видимости дочерних объектов
    var togleVisible = function(node, bool){
        node.visible = bool;
        if (node.children) {
            for (var i = 0; i < node.children.length; i++) {
                togleVisible(node.children[i], bool);
            }
        }
    }

    //изменение прозрачности дочерних объектов
    var togleOpacity = function(node, floatVal){
        node.material.opacity = floatVal;
        node.material.transparent = true;
        if (node.children) {
            for (var i = 0; i < node.children.length; i++) {
                togleOpacity(node.children[i], floatVal);
            }
        }
    }


	/* позиция камеры по умолчанию */
    /*camera.position.set(69, 69, -50);*/
    camera.position.set({{sceneop.camera_position_x|stringformat:"f"}}, {{sceneop.camera_position_y|stringformat:"f"}}, {{sceneop.camera_position_z|stringformat:"f"}});
    camera.PozOld = new THREE.Vector3({{sceneop.camera_position_x|stringformat:"f"}}, {{sceneop.camera_position_y|stringformat:"f"}}, {{sceneop.camera_position_z|stringformat:"f"}});
    /* вверх - это Z*/
    /*camera.up.set( 0, 0, -1 );*/
    camera.up.set({{sceneop.camera_up_x|stringformat:"f"}}, {{sceneop.camera_up_y|stringformat:"f"}}, {{sceneop.camera_up_z|stringformat:"f"}});
    scene.add(camera);


    /*камера. контроль за сменой позиции*/
    controls = new THREE.OrbitControls( camera, renderer.domElement );
    /* камера вращается вокруг данных координат*/
    controls.target.copy(new THREE.Vector3({{sceneop.controls_target_x|stringformat:"f"}}, {{sceneop.controls_target_y|stringformat:"f"}}, {{sceneop.controls_target_z|stringformat:"f"}}));
    controls.TarOld = new THREE.Vector3({{sceneop.controls_target_x|stringformat:"f"}}, {{sceneop.controls_target_y|stringformat:"f"}}, {{sceneop.controls_target_z|stringformat:"f"}})
    //камера смотрит
    camera.lookAt(new THREE.Vector3({{sceneop.controls_target_x|stringformat:"f"}}, {{sceneop.controls_target_y|stringformat:"f"}}, {{sceneop.controls_target_z|stringformat:"f"}}));
    camera.LookAt = new THREE.Vector3({{sceneop.controls_target_x|stringformat:"f"}}, {{sceneop.controls_target_y|stringformat:"f"}}, {{sceneop.controls_target_z|stringformat:"f"}});
    controls.addEventListener( 'change', render );
    hemi = new THREE.HemisphereLight(0xbbbbbb, 0x0099FF);
    scene.add(hemi);

    $("#webGL-container").append(renderer.domElement);

    /*статистика*/
    stats = new Stats();        
    stats.domElement.style.position = 'absolute';
    stats.domElement.style.left = '0px';
    stats.domElement.style.top = '0px';     
    $("#webGL-container").append( stats.domElement );       
	  }


    function render(){
        //плавное перемещение camera target
        if (camera.LookAtNew){
            oldCam = camera.LookAt;
            newCam = camera.LookAtNew;
            if (oldCam.x != newCam.x || oldCam.y != newCam.y || oldCam.z != newCam.z){
                var step = 0.50;

                xCur = oldCam.x;
                yCur = oldCam.y;
                zCur = oldCam.z;

                xNew = newCam.x;
                yNew = newCam.y;
                zNew = newCam.z;

                if((xCur <= xNew + step) && ((xNew - xCur) > 0)){
                    camera.lookAt(new THREE.Vector3(xCur += step, yCur, zCur));
                    oldCam.x += step;
                }

                else if((yCur <= yNew + step) && ((yNew - yCur) > 0)){
                    camera.lookAt(new THREE.Vector3(xCur, yCur += step, zCur));
                    oldCam.y += step;
                }

                else if((zCur <= zNew + step) && ((zNew - zCur) > 0)){
                    camera.lookAt(new THREE.Vector3(xCur, yCur, zCur += step));
                    oldCam.z += step;
                }

                else if((xCur >= xNew + step) && ((xNew - xCur) < 0)){
                    camera.lookAt(new THREE.Vector3(xCur -= step, yCur, zCur));
                    oldCam.x -= step;
                }

                else if((yCur >= yNew + step) && ((yNew - yCur) < 0)){
                    camera.lookAt(new THREE.Vector3(xCur, yCur -= step, zCur));
                    oldCam.y -= step;
                }

                else if((zCur >= zNew + step) && ((zNew - zCur) < 0)){
                    camera.lookAt(new THREE.Vector3(xCur, yCur, zCur -= step));
                    oldCam.z -= step
                }    
            }
        }
        //плавное перемещение target position
        if (controls.TarNew){
            oldCam = controls.TarOld;
            newCam = controls.TarNew;
            if (oldCam.x != newCam.x || oldCam.y != newCam.y || oldCam.z != newCam.z){
                var step = 0.50;

                xCur = oldCam.x;
                yCur = oldCam.y;
                zCur = oldCam.z;

                xNew = newCam.x;
                yNew = newCam.y;
                zNew = newCam.z;

                if((xCur <= xNew + step) && ((xNew - xCur) > 0)){
                    controls.target.copy(new THREE.Vector3(xCur += step, yCur, zCur));
                    oldCam.x += step;
                }

                if((yCur <= yNew + step) && ((yNew - yCur) > 0)){
                    controls.target.copy(new THREE.Vector3(xCur, yCur += step, zCur));
                    oldCam.y += step;
                }

                if((zCur <= zNew + step) && ((zNew - zCur) > 0)){
                    controls.target.copy(new THREE.Vector3(xCur, yCur, zCur += step));
                    oldCam.z += step;
                }


                if((xCur >= xNew + step) && ((xNew - xCur) < 0)){
                    controls.target.copy(new THREE.Vector3(xCur -= step, yCur, zCur));
                    oldCam.x -= step;
                }

                if((yCur >= yNew + step) && ((yNew - yCur) < 0)){
                    controls.target.copy(new THREE.Vector3(xCur, yCur -= step, zCur));
                    oldCam.y -= step;
                }

                if((zCur >= zNew + step) && ((zNew - zCur) < 0)){
                    controls.target.copy(new THREE.Vector3(xCur, yCur, zCur -= step));
                    oldCam.z -= step
                }    
            }
        }
    }


    function update(){
    }

    function animate(){
        requestAnimationFrame(animate);
        render();
        update();
        stats.update();     
        renderer.render(scene, camera);
    }

    init();
    animate();


    $(window).resize(function(){
        SCREEN_WIDTH = window.innerWidth;
        SCREEN_HEIGHT = window.innerHeight;
        camera.aspect = SCREEN_WIDTH / SCREEN_HEIGHT;
        camera.updateProjectionMatrix();
        renderer.setSize( SCREEN_WIDTH, SCREEN_HEIGHT );
    });

	</script>
    <script src="{% static 'js/jscolor.min.js'%}"></script>
    <script src="{% static 'js/foundation.js' %}"></script>
    <script src="{% static 'js/vendor/foundation.reveal.js' %}"></script>
    <script src="{% static 'js/vendor/what-input.min.js' %}"></script>
    <script src="{% static 'js/vendor/foundation.slider.js' %}"></script>
    <script src="{% static 'js/vendor/foundation.tabs.js' %}"></script>
    <script src="{% static 'js/vendor/foundation.util.timerAndImageLoader.js' %}"></script>
    <script src="{% static 'js/vendor/foundation.drilldown.js' %}"></script>
    <script src="{% static 'js/vendor/foundation.util.motion.js' %}"></script>
    <script src="{% static 'js/vendor/foundation.util.nest.js' %}"></script>
    <script src="{% static 'js/vendor/foundation.util.mediaQuery.js' %}"></script>
    <script src="{% static 'js/vendor/foundation.accordionMenu.js' %}"></script>
    <script>
        $(document).foundation();
        $('.is-drilldown').css('max-height', '300px');
    </script>
    {% else %}
        <div class="row">
            <h1>Информация скрыта. Необходима <a href="/login/"> авторизация.</a></h1>
        </div>
    {% endif %}
	</body>
</html>